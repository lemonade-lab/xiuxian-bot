import { APlugin, ClientNTQQ, Controllers, type AEvent } from 'alemonjs'
import {
  DB,
  GameApi,
  isThereAUserPresent,
  sendReply,
  victoryCooling,
  activityCooling,
  Server,
  getSkyComponent,
  postHelp
} from '../../api/index.js'

export class SkyTower extends APlugin {
  constructor() {
    super({
      rule: [
        {
          reg: /^(#|\/)?è¿›å…¥é€šå¤©å¡”$/,
          fnc: 'join'
        },
        {
          reg: /^(#|\/)?é€šå¤©å¡”$/,
          fnc: 'showSky'
        },
        {
          reg: /^(#|\/)?æŒ‘æˆ˜\d+$/,
          fnc: 'battle'
        }
      ]
    })
  }

  /**
   * è¿›å…¥é€šå¤©å¡”
   * @param e
   * @returns
   */
  async join(e: AEvent) {
    const UID = e.user_id
    if (!(await isThereAUserPresent(e, UID))) return
    if (!(await activityCooling(e, UID, 'é€šå¤©å¡”'))) return

    /**
     * æŸ¥çœ‹æ•°æ®æ˜¯å¦å­˜åœ¨
     */
    const data: DB.SkyType = (await DB.sky.findOne({
      where: {
        uid: UID
      },
      raw: true
    })) as any

    if (data) {
      e.reply('å·²è¿›å…¥', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    // æŸ¥çœ‹å¥–åŠ±
    e.reply(['è¿›å…¥[é€šå¤©å¡”]'], {
      quote: e.msg_id
    })
    postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
    Controllers(e).Message.reply('', [
      { label: 'æŒ‘æˆ˜', value: '/æŒ‘æˆ˜', enter: false },
      { label: 'æ§åˆ¶æ¿', value: '/æ§åˆ¶æ¿' }
    ])

    await DB.sky.create({
      uid: UID
    } as DB.SkyType)

    return
  }

  /**
   * é€šå¤©å¡”
   * @param e
   * @returns
   */
  async showSky(e: AEvent) {
    const UID = e.user_id
    if (!(await isThereAUserPresent(e, UID))) return
    if (!(await activityCooling(e, UID, 'é€šå¤©å¡”'))) return
    /**
     * æŸ¥çœ‹æ•°æ®æ˜¯å¦å­˜åœ¨
     */
    const data: DB.SkyType = (await DB.sky.findOne({
      where: {
        uid: UID
      },
      raw: true
    })) as any

    if (!data) {
      e.reply('æœªè¿›å…¥', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }
    const img = await getSkyComponent(await Server.showSky(UID), UID)
    if (typeof img != 'boolean') {
      e.reply(img)
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      Controllers(e).Message.reply('', [
        { label: 'æŒ‘æˆ˜', value: '/æŒ‘æˆ˜', enter: false },
        { label: 'æ§åˆ¶æ¿', value: '/æ§åˆ¶æ¿' }
      ])
    }
    return
  }

  /**
   * æŒ‘æˆ˜
   * @param e
   * @returns
   */
  async battle(e: AEvent) {
    const UID = e.user_id
    if (!(await isThereAUserPresent(e, UID))) return
    if (!(await activityCooling(e, UID, 'é€šå¤©å¡”'))) return

    const CDID = 23,
      CDTime = GameApi.Cooling.CD_B
    if (!(await victoryCooling(e, UID, CDID))) return

    /**
     * æŸ¥çœ‹æ•°æ®æ˜¯å¦å­˜åœ¨
     */
    const data: DB.SkyType = (await DB.sky.findOne({
      where: {
        uid: UID
      },
      raw: true
    })) as any

    if (!data) {
      e.reply('ğŸ˜ƒæœªè¿›å…¥', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    const id = Number(e.msg.replace(/^(#|\/)?æŒ‘æˆ˜/, ''))
    if (id >= data.id || id < 1) {
      e.reply('ğŸ˜…ä½ å¹²å˜›', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    // è®¾ç½®redis
    GameApi.Burial.set(UID, CDID, CDTime)

    const dataB: DB.SkyType = (await DB.sky.findOne({
      where: {
        id: id
      },
      raw: true
    })) as any

    // å¦‚æœå‘ç°æ‰¾ä¸åˆ°ã€‚å°±è¯´æ˜ä½ç½®æ˜¯ç©ºçš„ï¼Œå é¢†ä½ç½®ã€‚
    if (!dataB) {
      await DB.sky.update(
        {
          id
        },
        {
          where: {
            uid: data.uid
          }
        }
      )
      e.reply('ä½ç½®å é¢†æˆåŠŸ')
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    const UserDataB: DB.UserType = (await DB.user.findOne({
      where: {
        uid: dataB.uid
      },
      raw: true
    })) as any

    if (!UserDataB) {
      // ä¸å­˜åœ¨è¯¥ç”¨æˆ·äº†
      await DB.sky.update(
        {
          id
        },
        {
          where: {
            uid: data.uid
          }
        }
      )
      e.reply('ä½ç½®å é¢†æˆåŠŸ')
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    const UserData: DB.UserType = (await DB.user.findOne({
      where: {
        uid: UID
      },
      raw: true
    })) as any

    const BMSG = GameApi.Fight.start(UserData, UserDataB)

    // æ˜¯å¦æ˜¾ç¤ºæˆ˜æ–—ç»“æœ
    if (UserData.battle_show || UserDataB.battle_show) {
      // åˆ‡å‰²æˆ˜æ–—ä¿¡æ¯
      sendReply(e, '[æˆ˜æ–—ç»“æœ]', BMSG.msg)
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
    }

    if (BMSG.victory == '0') {
      /**
       * åé¦ˆæˆ˜æ–—ä¿¡æ¯
       */
      e.reply('ğŸ¤ªæŒ‘æˆ˜å¤±è´¥,ä½ ä¸å¯¹æ–¹æ‰“æˆäº†å¹³æ‰‹', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    if (BMSG.victory != UID) {
      /**
       * åé¦ˆæˆ˜æ–—ä¿¡æ¯
       */
      e.reply('ğŸ¤ªæŒ‘æˆ˜å¤±è´¥,ä½ è¢«å¯¹æ–¹å‡»è´¥äº†', {
        quote: e.msg_id
      })
      postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
      return
    }

    /**
     * å¦‚ä½•äº¤æ¢ä½ç½®ï¼Ÿ
     *
     * å¯¹æ–¹çš„  uid
     * å’Œè‡ªèº«çš„uid äº¤æ¢å³å¯
     *
     */

    await DB.sky.update(
      {
        // è‡ªèº«çš„ uid
        uid: data.uid
      },
      {
        where: {
          // ç›®æ ‡ id
          id: dataB.id
        }
      }
    )

    await DB.sky.update(
      {
        // å¯¹æ–¹çš„
        uid: dataB.uid
      },
      {
        where: {
          // è‡ªèº«çš„ id
          id: data.id
        }
      }
    )

    e.reply(`ğŸ˜¶æŒ‘æˆ˜æˆåŠŸ,å½“å‰æ’å${id}`, {
      quote: e.msg_id
    })
    postHelp(e,"[{\"group\":\"é€šå¤©å¡”\",\"list\":[{\"icon\":22,\"title\":\"/è¿›å…¥é€šå¤©å¡”\",\"desc\":\"å‡èšçµé­‚åŒ–èº«\"},{\"icon\":22,\"title\":\"/é€šå¤©å¡”\",\"desc\":\"æŸ¥çœ‹æ’å\"},{\"icon\":22,\"title\":\"/æŒ‘æˆ˜+æ’å\",\"desc\":\"æ‰€å‘æŠ«é¡\"}]},{\"group\":\"æå‡æˆ˜åŠ›\",\"list\":[{\"icon\":14,\"title\":\"/é—­å…³\",\"desc\":\"è¿›è¡Œé—­å…³\"},{\"icon\":14,\"title\":\"/å‡ºå…³\",\"desc\":\"å¢åŠ ä¿®ä¸º\"},{\"icon\":21,\"title\":\"/é”»ä½“\",\"desc\":\"è¿›è¡Œé”»ä½“\"},{\"icon\":21,\"title\":\"/å‡è„‰\",\"desc\":\"é”»ç‚¼æ°”è¡€\"},{\"icon\":21,\"title\":\"/æ‰“å\",\"desc\":\"èšé›†çµæ°”\"},{\"icon\":21,\"title\":\"/èšçµ\",\"desc\":\"å‡èšä½“å†…\"},{\"icon\":8,\"title\":\"/ç‚¼åŒ–+ç‰©å“å\",\"desc\":\"ç‚¼åŒ–ç‰©å“æœªæœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/ç²¾ç‚¼\",\"desc\":\"å¼ºåŒ–æœ¬å‘½ç‰©\"},{\"icon\":8,\"title\":\"/çªç ´\",\"desc\":\"ç»ƒæ°”å‡çº§\"},{\"icon\":8,\"title\":\"/ç ´å¢ƒ\",\"desc\":\"ç»ƒä½“å‡çº§\"}]},{\"group\":\"å…¶å®ƒ\",\"list\":[{\"icon\":16,\"title\":\"/æˆ˜æ–—å¸®åŠ©\",\"desc\":\"æˆ˜æ–—ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åœ°å›¾å¸®åŠ©\",\"desc\":\"åœ°å›¾ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/è”ç›Ÿå¸®åŠ©\",\"desc\":\"è”ç›Ÿç³»ç»Ÿ\"},{\"icon\":8,\"title\":\"/é»‘å¸‚å¸®åŠ©\",\"desc\":\"äº¤æ˜“ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/ä¿®ç‚¼å¸®åŠ©\",\"desc\":\"ä¿®ç‚¼ç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/èŒä¸šå¸®åŠ©\",\"desc\":\"èŒä¸šç³»ç»Ÿ\"},{\"icon\":16,\"title\":\"/åŠ¿åŠ›å¸®åŠ©\",\"desc\":\"åŠ¿åŠ›ç³»ç»Ÿ\"}]}]")
    return
  }
}
